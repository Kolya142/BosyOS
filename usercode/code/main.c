#include "bosyos/drivers.h"
#include "bosyos/bsfexe.h"
#include "bosystd.h"

uint16_t tones[] = { 79, 78, 76, 76, 78, 57, 62, 66, 62, 59, 62, 66, 62, 57, 62, 66, 69, 62, 79, 59, 78, 62, 76, 66, 76, 62, 57, 78, 62, 66, 62, 74, 59, 62, 76, 66, 69, 62, 57, 62, 66, 62, 59, 62, 66, 69, 62, 76, 59, 64, 78, 67, 79, 64, 59, 64, 76, 67, 73, 64, 57, 74, 64, 67, 64, 76, 57, 64, 69, 67, 69, 64, 57, 78, 62, 66, 62, 59, 62, 66, 62, 57, 62, 66, 62, 79, 59, 78, 62, 76, 66, 76, 62, 78, 57, 62, 66, 62, 59, 62, 66, 62, 57, 62, 66, 69, 62, 79, 59, 78, 62, 76, 66, 76, 62, 57, 62, 78, 66, 74, 62, 59, 62, 76, 66, 69, 62, 57, 62, 66, 62, 59, 62, 66, 62, 76, 59, 64, 78, 67, 79, 64, 59, 64, 76, 67, 73, 64, 57, 64, 74, 67, 76, 64, 57, 69, 64, 74, 67, 76, 64, 77, 58, 76, 62, 74, 65, 72, 70, 69, 70, 72, 53, 60, 77, 65, 60, 76, 55, 74, 62, 74, 65, 72, 62, 74, 57, 72, 60, 72, 65, 60, 72, 53, 60, 69, 65, 70, 60, 72, 53, 60, 77, 65, 60, 79, 55, 77, 62, 76, 65, 74, 62, 74, 57, 76, 60, 77, 65, 60, 77, 57, 60, 79, 65, 81, 60, 82, 58, 82, 65, 81, 69, 65, 79, 58, 65, 77, 69, 79, 65, 81, 57, 81, 60, 79, 65, 60, 77, 57, 60, 74, 65, 72, 60, 74, 57, 77, 60, 77, 65, 76, 60, 57, 76, 60, 78, 64, 78, 66, 50, 57, 78, 74, 50, 57, 71, 47, 54, 74, 78, 74, 47, 54, 69 };
uint16_t durations[] = { 1010, 249, 246, 246, 249, 0, 264, 248, 246, 249, 249, 246, 246, 249, 264, 248, 246, 0, 249, 0, 249, 0, 246, 0, 246, 0, 249, 264, 0, 248, 246, 249, 0, 249, 246, 0, 246, 0, 249, 264, 248, 246, 249, 249, 246, 246, 0, 249, 0, 264, 248, 0, 246, 0, 249, 249, 246, 0, 246, 0, 249, 264, 0, 248, 246, 249, 0, 249, 246, 0, 246, 0, 249, 264, 0, 248, 246, 249, 249, 246, 246, 249, 264, 248, 246, 249, 0, 249, 0, 246, 0, 246, 0, 249, 0, 264, 248, 246, 249, 249, 246, 246, 249, 264, 248, 246, 0, 249, 0, 249, 0, 246, 0, 246, 0, 249, 264, 248, 0, 246, 0, 249, 249, 246, 0, 246, 0, 249, 264, 248, 246, 249, 249, 246, 246, 249, 0, 264, 248, 0, 246, 0, 249, 249, 246, 0, 246, 0, 249, 264, 248, 0, 246, 0, 249, 249, 0, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 0, 744, 246, 249, 0, 264, 248, 0, 246, 249, 0, 249, 0, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 249, 0, 249, 246, 0, 246, 0, 249, 0, 264, 248, 0, 246, 249, 0, 249, 0, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 249, 0, 249, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 249, 0, 249, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 249, 0, 249, 246, 0, 246, 0, 249, 0, 264, 0, 248, 0, 246, 0, 249, 249, 0, 246, 0, 246, 0, 249, 0, 512, 246, 0, 0, 249, 0, 0, 249, 246, 246, 0, 0, 249 };

void mainer() {

    syscall(1, (uint32_t)"Hello, world!\n", 0, 0, 0);
    // for (uint32_t i = 0; i < sizeof(tones) / 2; ++i) {
    //     drvcall(DRVBEEP, 2, (tones[i] << 16) | durations[i]);
    //     syscall(4, 1000/120, 0, 0, 0);
    // }
    exit(0);
}

void mainer1() {
    for (uint32_t i = 0; i < sizeof(tones) / 2; ++i) {
        // syscall(8, tones[i], durations[i], 0, 0);
        drvcall(DBEEP, 2, ((tones[i]) << 16) | durations[i]);
        syscall(4, 1000/120, 0, 0, 0);
    }
    exit(0);
}

void mainer2() {
    String str = "\nSERIAL2VGA START: ";
    for (U32 i = 0; str[i]; ++i)
        drvcall(DSERIAL, 0, str[i]);
    for (;;) {
        U8 c = drvcall(DSERIAL, 1, 0);
        if (c == ':') {
            c = drvcall(DSERIAL, 1, 0);
            if (c == 'q') {
                break;
            }
        }
        syscall(6, c, 0, 0, 0);
    }
    exit(0);
}

void game() {
    U8 keys[32] = {0};
    U32 tail[5] = {0};
    tail[0] = 80 * 10 + 39;
    tail[1] = 80 * 10 + 38;
    tail[2] = 80 * 10 + 37;
    tail[3] = 80 * 10 + 36;
    tail[4] = 80 * 10 + 35;
    U32 snake = 80 * 10 + 40;
    U32 apple = drvcall(DRAND, 0, 0) % 1300 + 500;
    U32 score = 0;
    U8 dir = 4;
    
    Bool game = True;
    while (game) {
        if (drvcall(DKEYBOARD, 3, 'w')) {
            dir = 1;
        }
        else if (drvcall(DKEYBOARD, 3, 'a')) {
            dir = 2;
        }
        else if (drvcall(DKEYBOARD, 3, 's')) {
            dir = 3;
        }
        else if (drvcall(DKEYBOARD, 3, 'd')) {
            dir = 4;
        }

        for (U8 i = 4; i >= 1; --i) {
            ((U16*)0xb8000)[tail[i]] = 0xF000 | ' ';
            
            tail[i] = tail[i-1];
        }
        tail[0] = snake;

        if (snake == apple) {
            score++;
            ((U16*)0xb8000)[apple] = 0xF02E;
            apple = drvcall(DRAND, 0, 0) % 1300 + 500;
        }

        if (dir == 1      && ((snake - 80) < 0xFFFFFFF)) {
            snake -= 80;
        }
        else if (dir == 2 && (snake - 1) % 80 != 80 - 1) {
            snake -= 1;
        }
        else if (dir == 3 && ((snake + 80) < 80 * 25) )  {
            snake += 80;
        }
        else if (dir == 4 && ((snake + 1) % 80 != 0)) {
            snake += 1;
        }

        for (U8 i = 0; i < 5; ++i) {
            ((U16*)0xb8000)[tail[i]] = 0xF000 | '#';
            // if (tail[i] == snake) {
            //     for (U32 i = 0; i < 2000; ++i) {
            //         vga[i] ^= 0xFF00;
            //     }
            //     TTYCursor = 0;
            //     TTYUPrint("Game over!\n");
            //     game = False;
            //     break;
            // }
        }
        if (drvcall(DKEYBOARD, 3, '\x1b')) {
            game = False;
        }
        ((U16*)0xb8000)[apple] = 0xC000 | ' ';

        syscall(4, 100, 0, 0, 0);
    }
    syscall(1, (U32)"$!F$*0", 0, 0, 0);
    exit(0);
}

void user() {
    for(;;);
}
FUNCTION(mainer, 0, 1)
FUNCTION(mainer1, 0, 2)
FUNCTION(mainer2, 0, 3)
FUNCTION(game, 0, 4)
FUNCTION(user, 0, 5)